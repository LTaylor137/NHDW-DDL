



-- pull data from DDDM_TPS_1.DBO.PATIENT and insert it into a temptable. 
DROP PROCEDURE IF EXISTS TRANSFER_DATA_TO_TEMP_MEAS_STORAGE
GO
CREATE PROCEDURE TRANSFER_DATA_TO_TEMP_MEAS_STORAGE
AS
BEGIN

    -- get a string of id's already in EE and DW tables.
    DECLARE @ALREADY_IN_DIM NVARCHAR(MAX);
    SELECT @ALREADY_IN_DIM = COALESCE(@ALREADY_IN_DIM + ',', '') + URNUMBER
    FROM NHDW_LDT_0214.DBO.DW_MEASUREMENT
    -- WHERE DWSOURCEDB = 'NHRM';

    DECLARE @IN_ERROR_EVENT NVARCHAR(MAX);
    SELECT @IN_ERROR_EVENT = COALESCE(@IN_ERROR_EVENT + ',', '') + SOURCE_ID
    FROM NHDW_LDT_0214.DBO.ERROR_EVENT
    -- WHERE DWSOURCEDB = 'NHRM';

    DECLARE @TO_EXCLUDE NVARCHAR(MAX)
    SET @TO_EXCLUDE = @ALREADY_IN_DIM + ',' + @IN_ERROR_EVENT;
    PRINT @TO_EXCLUDE;

    -- get connection string
    DECLARE @CONNECTIONSTRING NVARCHAR(MAX);
    EXECUTE @CONNECTIONSTRING = GET_CONNECTION_STRING;
    -- (
    --     DWMEASUREMENTID INTEGER NOT NULL,
    --     MEASUREMENTID INTEGER NOT NULL,
    --     DATAPOINTNUMBER INTEGER NOT NULL,
    --     DWSOURCEBD NVARCHAR(50) NOT NULL,
    --     DWSOURCETABLE NVARCHAR(50) NOT NULL,
    --     MEASUREMENTNAME NVARCHAR(50) NOT NULL,
    --     [NAME] NVARCHAR(50) NOT NULL,
    --     UPPERLIMIT INTEGER NOT NULL,
    --     LOWERLIMIT INTEGER NOT NULL,
    --     QUESTION NVARCHAR(255) NOT NULL,
    --     ANSWERNUMBER INTEGER NULL,
    --     PRIMARY KEY (DWMEASUREMENTID)
    -- );

    DROP TABLE IF EXISTS TEMPMEASUREMENTTABLE;
    CREATE TABLE TEMPMEASUREMENTTABLE
    (
        MEASUREMENTID INT,
        DATAPOINTNUMBER INT,
        MEASUREMENTNAME NVARCHAR(100),
        [NAME] NVARCHAR(100),
        UPPERLIMIT INT,
        LOWERLIMIT INT
    )

    DECLARE @INSERTQUERY NVARCHAR(MAX);
    SET @INSERTQUERY = 'INSERT INTO TEMPMEASUREMENTTABLE SELECT MEASUREMENTID, DATAPOINTNUMBER, MEASUREMENTNAME, [NAME], UPPERLIMIT, LOWERLIMIT'

    -- write the code to get the required data - excludes those identified above.
    DECLARE @SELECTQUERY NVARCHAR(MAX);
    SET @SELECTQUERY = '''SELECT URNUMBER, GENDER, YEAR(DOB) AS DOB,' +
                    'SUBURB, POSTCODE, COUNTRYOFBIRTH, LIVESALONE, ACTIVE, ' +
                    '(SELECT TOP 1 DIAGNOSIS FROM DDDM_TPS_1.DBO.CONDITIONDETAILS CD WHERE CD.URNUMBER = P.URNUMBER) AS [DIAGNOSIS],' +

                    '(SELECT TOP 1 CATEGORYNAME FROM DDDM_TPS_1.DBO.PATIENTCATEGORY PC' +
                    ' INNER JOIN DDDM_TPS_1.DBO.TEMPLATECATEGORY TC' +
                    ' ON PC.CATEGORYID = TC.CATEGORYID' +
                    ' WHERE PC.URNUMBER = P.URNUMBER) AS [CATEGORY], ' +

                    '(SELECT TOP 1 PROCEDUREDATE FROM DDDM_TPS_1.DBO.CONDITIONDETAILS CD WHERE CD.URNUMBER = P.URNUMBER) AS [PROCEDURE]' +
                    ' FROM DDDM_TPS_1.DBO.PATIENT P WHERE URNUMBER NOT IN (' + @TO_EXCLUDE + ')''';

    DECLARE @COMMAND NVARCHAR(MAX);
    SET @COMMAND = @INSERTQUERY + ' FROM OPENROWSET(''SQLNCLI'', ' + '''' + @CONNECTIONSTRING + ''',' + @SELECTQUERY + ');'

    SELECT *
    FROM TEMPMEASUREMENTTABLE
    -- view table before 

    PRINT('---- this is the command ----  ' + @COMMAND);
    EXECUTE(@COMMAND);

    SELECT *
    FROM NHDW_LDT_0214.DBO.TEMPMEASUREMENTTABLE
-- view table after 

END;

EXEC TRANSFER_DATA_TO_TEMP_MEAS_STORAGE;

SELECT *
FROM DW_PATIENT

SELECT *
FROM TEMPTABLE

SELECT *
FROM NHDW_LDT_0214.DBO.ERROR_EVENT


SELECT *
FROM
    OPENROWSET('SQLNCLI', 'Server=dad.cbrifzw8clzr.us-east-1.rds.amazonaws.com;UID=ldtreadonly;PWD=Kitemud$41;',
'SELECT * FROM DDDM_TPS_1.dbo.PATIENT');
----------------------------------------------------------------------------------------
----------------------------------- Apply Filters --------------------------------------
----------------------------------------------------------------------------------------

